多表分组查询

SQL：

```mysql
# 查询出每个出版社的名称，并统计每个出版社的出版的书籍总数
# SQL：inner join连接两张表后，再进行group by查询
select count(title) from app01_book inner join app01_publish
on app01_book.publish_id = app01_publish.nid
group by publish_id
```

ORM：

美 /'ænə'tet/  注释 

跨表分组查询模型：

```
表模型.objects.values('pk主键').annotate(聚合函数(关联表__统计字段)).values(要展示的列1，要展示的列2)
```



#### 题干：查询出每个出版社的名称，并统计每个出版社的出版的书籍总数

```python
def query():
    # 在出版社表中按出版社表的的主键nid进行分组，就取到了每个出版社，在annotate的统计中，跨表统计书籍的数量。以什么分组就会打印该列的内容，所以使用values(),去打印想要展示的列
    # SELECT `app01_publish`.`name`, COUNT(`app01_book`.`title`) AS `book_count` FROM `app01_publish`
    # LEFT OUTER JOIN `app01_book` 
    # ON (`app01_publish`.`nid` = `app01_book`.`publish_id`)
    # GROUP BY `app01_publish`.`nid`
    ret=Publish.objects.values('nid').annotate(book_count=Count('book__title')).values('name','book_count')
    print(ret)

    # <QuerySet [{'name': '北京出版社', 'book__title__count': 5}]>
    # SELECT `app01_publish`.`name`, COUNT(`app01_book`.`title`) AS `book__title__count` FROM `app01_publish` 
    # LEFT OUTER JOIN `app01_book` 
    # ON (`app01_publish`.`nid` = `app01_book`.`publish_id`)
    # GROUP BY `app01_publish`.`name`
    ret=Publish.objects.values('name').annotate(Count('book__title'))
    print(ret)

    return HttpResponse('OK')
```



#### 题干：查询每一个作者的名字以及出版过的书籍的最高价格

```python
def query():
    # <QuerySet [{'name': 'alex', 'max_price': Decimal('199.00')}, {'name': 'egon', 'max_price': Decimal('199.00')}]>
    # SELECT app01_author.name, MAX(app01_book.price) AS max_price FROM app01_book
    # inner join app01_book_authors
    # ON (app01_book.nid = app01_book_authors.book_id)
    # inner join app01_author
    # ON (app01_book_authors.author_id = app01_author.nid)
    # GROUP BY app01_book_authors.author_id
# 正向查询：
ret=Book.objects.values('authors__nid').annotate(max_price=Max('price')).values('authors__name','max_price')
    print(ret)
# 反向查询：
ret=Author.objects.values('nid').annotate(max_price=Max('book__price')).values('name','max_price')
    print(ret)

    return HttpResponse('OK')
```

